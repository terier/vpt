#!/usr/bin/env node

var fs = require('fs');
var path = require('path');

var dependencies = {};
var queue = process.argv.slice(2).reverse().map(x => path.resolve(x));

while (queue.length > 0) {
    var file = queue.pop();
    if (file in dependencies) {
        continue;
    }

    // Read file
    try {
        var content = fs.readFileSync(file, 'utf8');
    } catch(e) {
        console.error('Cannot read file: ' + file);
        process.exit(-1);
    }

    // Extract and path-resolve dependencies
    var includeRe = /@@\S+/g;
    var matches = content.match(includeRe) || [];
    var files = matches.map(x => path.resolve(path.dirname(file), x.substring(2)));
    queue = queue.concat(files);
    dependencies[file] = files;
}

// Topological sort
while (Object.keys(dependencies).length > 0) {
    var standalones = Object.keys(dependencies).filter(x => dependencies[x].length === 0);
    if (standalones.length === 0) {
        console.error('Circular dependencies detected');
        process.exit(-1);
    }

    // Pick first standalone file, output it, and remove it from the graph
    var next = standalones[0];
    console.log(next);
    delete dependencies[next];
    for (key in dependencies) {
        dependencies[key] = dependencies[key].filter(x => x !== next);
    }
}
